// This is your Prisma schema file for Irish Health Insurance Chooser
// Tracks user sessions, quiz responses, recommendations, and historical statistics

generator client {
  provider = "prisma-client"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// Session: Represents a complete user journey through the quiz
model Session {
  id                    String    @id @default(cuid())
  
  // Session metadata
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  completedAt           DateTime?
  
  // User responses to quiz questions
  responses             SessionResponse[]
  
  // Recommended plans for this session
  recommendedPlans      SessionPlan[]
  
  // Statistics tracking
  statistics            Statistics?
}

// Individual quiz response
model SessionResponse {
  id          String   @id @default(cuid())
  sessionId   String
  session     Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  questionId  String
  answer      String   // User's answer to the question
  
  createdAt   DateTime @default(now())
  
  @@index([sessionId])
}

// Plan: Represents a health insurance plan
model Plan {
  id                String   @id @default(cuid())
  
  // Basic plan information
  name              String
  provider          String
  description       String?
  
  // Pricing
  monthlyPremium    Decimal  @db.Decimal(10, 2)
  annualPremium     Decimal  @db.Decimal(10, 2)
  
  // Coverage details
  coverageDetails   String?  // JSON string of coverage details
  
  // Plan metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  sessionPlans      SessionPlan[]
}

// SessionPlan: Represents a recommended plan for a session
model SessionPlan {
  id          String   @id @default(cuid())
  sessionId   String
  session     Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  planId      String
  plan        Plan     @relation(fields: [planId], references: [id])
  
  // Recommendation score
  score       Int      // 0-100 match percentage
  
  createdAt   DateTime @default(now())
  
  @@index([sessionId])
  @@index([planId])
}

// Statistics: Aggregated statistics for a session
model Statistics {
  id          String   @id @default(cuid())
  sessionId   String   @unique
  session     Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Quiz completion metrics
  questionsAnswered Int
  totalQuestions    Int
  completionRate    Decimal @db.Decimal(5, 2)
  
  // Recommendation metrics
  topPlanScore      Int
  averageScore      Decimal @db.Decimal(5, 2)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// QuestionStatistics: Tracks statistical properties of each question
model QuestionStatistics {
  id                    String   @id @default(cuid())
  
  // Question metadata
  questionId            String   @unique
  questionText          String
  category              String   // e.g., "coverage", "price", "provider"
  
  // Statistical properties
  discriminativePower   Decimal  @db.Decimal(5, 3) @default(0.5)  // 0-1 scale
  responseDistribution  String?  // JSON: { "answer1": count, "answer2": count, ... }
  
  // Usage tracking
  totalResponses        Int      @default(0)
  lastUpdated           DateTime @updatedAt
  
  createdAt             DateTime @default(now())
}

// QuestionResponseAnalytics: Detailed analytics for question responses
model QuestionResponseAnalytics {
  id                String   @id @default(cuid())
  
  questionId        String
  answer            String
  
  // Analytics
  responseCount     Int      @default(0)
  planMatchRate     Decimal  @db.Decimal(5, 3)  // How often this answer leads to plan matches
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([questionId, answer])
}

// AdaptiveQuizSession: Tracks adaptive quiz sessions with ranking
model AdaptiveQuizSession {
  id                    String   @id @default(cuid())
  
  // Session metadata
  userId                String?  // Optional user ID if authentication is added
  startedAt             DateTime @default(now())
  completedAt           DateTime?
  
  // Quiz progress
  currentQuestionIndex  Int      @default(0)
  totalQuestionsToAsk   Int      @default(10)  // Adaptive: can vary
  
  // Responses in this session
  responses             String?  // JSON: { "questionId": "answer", ... }
  
  // Ranking state
  questionRankingCache  QuestionRankingCache?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// QuestionRankingCache: Caches ranked questions for adaptive quiz
model QuestionRankingCache {
  id                    String   @id @default(cuid())
  
  sessionId             String   @unique
  session               AdaptiveQuizSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Ranked questions (JSON array of question IDs in order)
  rankedQuestionIds     String   // JSON: ["q1", "q2", "q3", ...]
  
  // Cache metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}
